{% extends "base.html" %}
{% block content %}
<ul class="nav nav-tabs" id="mainTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="inference-tab" data-bs-toggle="tab" data-bs-target="#inference" type="button" role="tab">Inference</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="preprocess-tab" data-bs-toggle="tab" data-bs-target="#preprocess" type="button" role="tab">Preprocess</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="outputs-tab" data-bs-toggle="tab" data-bs-target="#outputs" type="button" role="tab">Outputs</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="live-tab" data-bs-toggle="tab" data-bs-target="#live" type="button" role="tab">Live</button>
  </li>
</ul>

<div class="tab-content pt-3" id="mainTabsContent">
  <div class="tab-pane fade show active" id="inference" role="tabpanel">
    <div class="row g-4">
      <div class="col-lg-4">
        <div class="card shadow-sm">
          <div class="card-header">Upload Image</div>
          <div class="card-body">
            <form action="/upload" method="post" enctype="multipart/form-data">
              <div class="mb-3">
                <input class="form-control" type="file" name="file" accept="image/*" required />
              </div>
              <button class="btn btn-primary" type="submit">Upload</button>
            </form>
          </div>
        </div>

        <div class="card shadow-sm mt-4">
          <div class="card-header">Model Selection</div>
          <div class="card-body">
            <div class="d-flex gap-2 mb-3">
              <button class="btn btn-outline-secondary" onclick="loadModel('blob')">Blob Detector</button>
              <button class="btn btn-outline-primary" onclick="loadModel('yolo')">YOLO (if available)</button>
            </div>
            <form onsubmit="event.preventDefault(); selectModelFolder();">
              <label class="form-label">Model folder path (with model.py)</label>
              <input id="modelFolder" class="form-control" placeholder="C:\\path\\to\\model_folder" />
              <button class="btn btn-success mt-2" type="submit">Load Plugin Model</button>
            </form>
          </div>
        </div>
      </div>

      <div class="col-lg-8">
        <div class="card shadow-sm">
          <div class="card-header">Images</div>
          <div class="card-body">
            {% if images %}
            <div class="list-group" id="image-list">
              {% for img in images %}
              <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="selectImage('{{ img }}')">
                <span>{{ img }}</span>
                <span>
                  <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); runInference('{{ img }}')">Run Inference</button>
                </span>
              </button>
              {% endfor %}
            </div>
            {% else %}
            <p class="text-muted">No images uploaded yet.</p>
            {% endif %}
          </div>
        </div>

        <div class="card shadow-sm mt-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Results</span>
            <span id="selected-image" class="badge bg-secondary">None selected</span>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <img id="overlay" class="img-fluid rounded border" alt="Overlay" />
              </div>
              <div class="col-md-6">
                <canvas id="statsChart" height="180"></canvas>
                <div class="mt-2" id="statsText"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="tab-pane fade" id="preprocess" role="tabpanel">
    <div class="card shadow-sm">
      <div class="card-header">Preprocess Operations</div>
      <div class="card-body">
        <div class="btn-group" role="group">
          <button class="btn btn-outline-secondary" onclick="preprocessSelected('gray')">Grayscale</button>
          <button class="btn btn-outline-secondary" onclick="preprocessSelected('clahe')">Contrast (CLAHE)</button>
          <button class="btn btn-outline-secondary" onclick="preprocessSelected('equalize')">Equalize Hist</button>
          <button class="btn btn-outline-secondary" onclick="preprocessSelected('gradient')">Gradient</button>
        </div>
        <p class="mt-3 text-muted">Select an image from the Inference tab first, then apply operations here. We can easily add more operations to this tab.</p>
      </div>
    </div>
  </div>

  <div class="tab-pane fade" id="outputs" role="tabpanel">
    <div class="row g-4">
      <div class="col-lg-4">
        <div class="card shadow-sm">
          <div class="card-header">Dataset</div>
          <div class="card-body">
            <form onsubmit="event.preventDefault(); ingestDataset();">
              <label class="form-label">Dataset folder path</label>
              <input id="datasetFolder" class="form-control" placeholder="C:\\path\\to\\dataset" />
              <button class="btn btn-primary mt-2" type="submit">Load Dataset</button>
            </form>
            <div class="mt-3">
              <label class="form-label">Time</label>
              <input id="timeSlider" type="range" min="0" max="0" value="0" class="form-range" oninput="onTimeChange(this.value)" />
              <div id="timeLabel" class="mt-2">t = 0</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-8">
        <div class="card shadow-sm">
          <div class="card-header">Frame Output</div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <img id="frameOverlay" class="img-fluid rounded border" alt="Frame Overlay" />
              </div>
              <div class="col-md-6">
                <canvas id="frameChart" height="180"></canvas>
                <div class="mt-2" id="frameStats"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="tab-pane fade" id="live" role="tabpanel">
    <div class="card shadow-sm">
      <div class="card-header">Live Stream</div>
      <div class="card-body">
        <div class="d-flex gap-2 mb-3">
          <button class="btn btn-success" onclick="startLivePolling()">Start Live</button>
          <button class="btn btn-danger" onclick="stopLivePolling()">Stop Live</button>
        </div>
        <form onsubmit="event.preventDefault(); sendLiveFrame();" class="mb-3">
          <div class="row g-2 align-items-center">
            <div class="col-md-6">
              <input id="liveFile" class="form-control" type="file" accept="image/*" />
            </div>
            <div class="col-md-3">
              <input id="liveTs" class="form-control" type="number" step="0.01" placeholder="timestamp (s)" />
            </div>
            <div class="col-md-3">
              <button class="btn btn-outline-primary" type="submit">Send Frame</button>
            </div>
          </div>
        </form>
        <div class="row">
          <div class="col-md-6">
            <img id="liveOverlay" class="img-fluid rounded border" alt="Live Overlay" />
          </div>
          <div class="col-md-6">
            <canvas id="liveChart" height="180"></canvas>
            <div class="mt-2" id="liveStats"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}